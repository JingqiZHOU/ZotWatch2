# ZotWatch 算法

本文档详细说明了 ZotWatch 的核心数据处理流程，包括用户研究画像的构建、基于显式兴趣的推荐以及基于隐式画像的推荐。

## 1. 用户研究画像构建

用户画像是 ZotWatch 理解科研兴趣的基石。该模块负责将用户的 Zotero 文献库转化为结构化的向量空间和语义聚类。

### 1.1 向量化与索引

系统首先提取用户文献库中所有包含摘要（Abstract）的条目。
- **Embedding**：使用预训练模型（如 Voyage AI 或 DashScope）将 `Title + Abstract` 转化为高维向量。
- **FAISS Index**：构建 FAISS 索引以便于后续的高效相似度检索。

### 1.2 时间衰减权重

为了解决“陈旧兴趣”干扰推荐的问题，系统引入了基于半衰期的时间权重机制。
- **逻辑**：越近加入 Zotero 的文献权重越高，越久远的文献权重按指数衰减。
- **公式**：$w(t) = 2^{-t / T_{1/2}}$。其中 $t$ 为距今的天数，$T_{1/2}$ 为设定的半衰期（天，代码中当前默认值为 180）。
- **应用**：这些权重被用于计算聚类的“加权质心”以及后续推荐中的微观打分。

### 1.3 自适应语义聚类

系统使用 Spherical K-Means 算法自动发现用户的研究领域。

- **动态 K 值搜索范围**:
    - 对于文献数量 $N < 5$ 的极小规模库，视为单簇处理。
    - 对于 $N \ge 5$，系统会在 $[2, K_{\max}]$ 范围内搜索最优聚类数。
    - **上限计算（$K_{\max}$）**：摒弃了僵硬的线性比例限制，改用 **平方根律（$\sqrt{N}$）** 自适应计算。
        - 公式逻辑：$K_{\max} \approx \min\bigl(35, \max(5, \sqrt{N})\bigr)$。
        - *目的*：确保即使在只有 40-50 篇文献的冷启动阶段，也能尝试划分出 4-6 个细分领域，而不是被强制压缩为 1-2 类。

- **评估指标**：使用 **Silhouette Score (轮廓系数)** 结合余弦距离评估聚类质量。

- **带偏好的 K 值决策 (Biased Selection)**:
    - 算法倾向于选择**粒度更细**的聚类方案，而非盲目追求分数的数学极值。
    - **策略**：设定容忍度阈值（如 10%）。如果在全局最高分（$S_{\max}$）的容忍范围内存在更大的 $k$ 值，系统会优先选择更大的 $k$。
    - *意义*：这能有效挖掘出大领域下的细分研究分支（例如将“深度学习”进一步拆解为“LLM”和“Vision”），提供更具信息量的用户画像。

- **聚类属性**：每个聚类包含质心向量、加权质心（考虑时间衰减）、有效大小（Effective Size）和关键词标签。

## 2. 基于兴趣的推荐

该模块处理用户的**显式需求**（如配置文件中定义的 `interests` 描述），适用于追踪特定主题或新方向。

### 2.1 流程概览

采用 **Recall（召回）+ Rerank（重排序）** 的两阶段架构。

1. **LLM 意图细化**:
    - 使用 LLM 将用户的自然语言描述转化为更适合检索的 `refined_query`。
    - 自动提取 `include_keywords` 和 `exclude_keywords`。

2. **硬过滤**:
    - 根据排除关键词直接剔除不相关的候选文献。

3. **FAISS 向量召回**:
    - 将候选文献编码为向量。
    - 使用 `refined_query` 在候选集中进行 Top-K 近邻搜索（K 由 `max_documents` 限制）。

4. **语义重排序**:
    - 调用高精度的 Rerank 模型（如 Voyage Reranker），对召回的文献进行成对打分。
    - 这是决定最终排序的关键步骤，能精准捕捉复杂的语义相关性。

5. **最终打分**:
    - 主要依据 Rerank Score，同时结合期刊影响因子（Impact Factor）信息进行展示。

## 3. 基于画像的推荐

该模块处理用户的**隐式偏好**，基于用户已有的文献库进行“猜你喜欢”式的推荐。

### 3.1 混合打分机制

系统采用“微观-宏观”融合策略来计算候选文献与用户画像的相似度（记为 $S_{\mathrm{fusion}}$）。

- **微观打分（Micro Score, $S_{\mathrm{micro}}$）**:
    - **逻辑**：基于 k-NN（最近邻）。计算候选文献与用户库中 $k$ 篇最相似文献的加权平均相似度。
    - **时间感知**：引入之前计算的 Temporal Weights。如果候选文献只与用户库中很久以前的论文相似，得分会被压低；如果与近期论文相似，得分会显著提高。
    - 公式：$S_{\mathrm{micro}} = \left(\sum_i s_i w_i\right) / \left(\sum_i w_i + \varepsilon\right)$。

- **宏观打分（Macro Score, $S_{\mathrm{macro}}$）**:
    - **逻辑**：基于聚类质心。计算候选文献与用户各个研究领域（聚类）质心的相似度。
    - **热度加权**：相似度会乘以 $\log\bigl(1 + n_{\mathrm{eff}}\bigr)$，其中 $n_{\mathrm{eff}}$ 为该聚类的有效大小（Effective Size），倾向于推荐用户投入更多精力的领域。

- **融合公式**:

    $$
    S_{\mathrm{fusion}} = \alpha S_{\mathrm{micro}} + (1 - \alpha) S_{\mathrm{macro}}
    $$

    其中 $\alpha$ 通常设为 $0.6$ 左右，更侧重具体的微观相似性。

### 3.2 综合排序

最终得分（$S_{\mathrm{final}}$）结合了内容相似度和期刊质量：

$$
S_{\mathrm{final}} = 0.8\, S_{\mathrm{fusion}} + 0.2\, S_{\mathrm{IF}}
$$

### 3.3 动态阈值分级

系统不使用固定的分数线，而是根据当前批次文献的分数分布动态计算阈值，将论文分为三类：
- **Must Read**：分数位于前 ~5% (动态计算)。
- **Consider**：分数位于前 ~20%。
- **Ignore**：其余文献。

这种机制保证了无论候选文献整体质量如何，用户总能看到相对最好的推荐。

### 3.4 冷启动处理

如果用户的 Profile 为空（新用户），系统会自动降级为 **Random Mode**，随机打散候选文献并标记为 `consider`，以鼓励用户探索并建立初始画像。